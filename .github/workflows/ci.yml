name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-qt coverage

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 libegl1-mesa

    - name: Run Tests with Coverage
      run: |
        xvfb-run -a pytest --cov=core --cov=engine --cov=macro --cov=ui --cov=scheduler --cov-report=term-missing --cov-report=xml tests/ | tee coverage.txt

    - name: Create Coverage Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let coverage = '';
          try {
            coverage = fs.readFileSync('coverage.txt', 'utf8');
          } catch (e) {
            coverage = 'Coverage report not found or failed.';
          }

          const output = `#### Test Coverage Report ðŸ“Š

          <details><summary>Show Coverage Details</summary>

          \`\`\`text
          ${coverage}
          \`\`\`

          </details>

          *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
